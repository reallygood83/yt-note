'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';

interface SavedNote {
  id: string;
  title: string;
  channelTitle: string;
  duration: string;
  keyInsight: string;
  youtubeUrl: string;
  createdAt: string;
  sections?: any[];
}

export default function MyNotesPage() {
  const [savedNotes, setSavedNotes] = useState<SavedNote[]>([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [filteredNotes, setFilteredNotes] = useState<SavedNote[]>([]);

  useEffect(() => {
    // μ €μ¥λ λ…ΈνΈ λ¶λ¬μ¤κΈ°
    const notes = JSON.parse(localStorage.getItem('saved_notes') || '[]');
    setSavedNotes(notes);
    setFilteredNotes(notes);
  }, []);

  useEffect(() => {
    // κ²€μƒ‰ ν•„ν„°λ§
    if (searchTerm) {
      const filtered = savedNotes.filter(note => 
        note.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
        note.channelTitle.toLowerCase().includes(searchTerm.toLowerCase()) ||
        note.keyInsight.toLowerCase().includes(searchTerm.toLowerCase())
      );
      setFilteredNotes(filtered);
    } else {
      setFilteredNotes(savedNotes);
    }
  }, [searchTerm, savedNotes]);

  const deleteNote = (id: string) => {
    if (confirm('μ΄ λ…ΈνΈλ¥Ό μ‚­μ ν•μ‹κ² μµλ‹κΉ?')) {
      const updatedNotes = savedNotes.filter(note => note.id !== id);
      setSavedNotes(updatedNotes);
      localStorage.setItem('saved_notes', JSON.stringify(updatedNotes));
    }
  };

  const clearAllNotes = () => {
    if (confirm('λ¨λ“  λ…ΈνΈλ¥Ό μ‚­μ ν•μ‹κ² μµλ‹κΉ? μ΄ μ‘μ—…μ€ λλλ¦΄ μ μ—†μµλ‹λ‹¤.')) {
      setSavedNotes([]);
      localStorage.removeItem('saved_notes');
    }
  };

  const downloadNote = (note: SavedNote) => {
    const markdownContent = `# ${note.title}

**μ±„λ„:** ${note.channelTitle}
**μμƒ κΈΈμ΄:** ${note.duration}
**YouTube:** ${note.youtubeUrl}
**μƒμ„±μΌ:** ${new Date(note.createdAt).toLocaleDateString('ko-KR')}

## π― ν•µμ‹¬ μΈμ‚¬μ΄νΈ
${note.keyInsight}

## π“ νƒ€μ„μ¤νƒ¬ν”„λ³„ μ •λ¦¬

${note.sections?.map((section: any) => `
### π“ [${section.timeRange}] ${section.title}

**ν•µμ‹¬ λ‚΄μ©:**
${section.content}

**π’΅ ν•µμ‹¬ κ°λ…:** ${section.keyConcepts?.join(', ') || ''}
**β΅ μ•΅μ… ν¬μΈνΈ:** ${section.actionPoints?.join(', ') || ''}

---
`).join('') || ''}

## β… ν•™μµ μ²΄ν¬λ¦¬μ¤νΈ

- [ ] μμƒ μ‹μ²­ μ™„λ£
- [ ] ν•µμ‹¬ κ°λ… μ΄ν•΄
- [ ] μ•΅μ… ν¬μΈνΈ μ‹¤ν–‰
- [ ] λ³µμµ μ™„λ£

---
*Generated by YouTube Learning Note Generator*
`;

    const blob = new Blob([markdownContent], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${note.title.replace(/[^a-zA-Z0-9κ°€-ν£]/g, '_')}.md`;
    a.click();
    URL.revokeObjectURL(url);
  };

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="container mx-auto px-4 py-8 max-w-6xl">
        {/* Header */}
        <div className="bg-white rounded-lg shadow-lg p-6 mb-8">
          <div className="flex items-center justify-between mb-4">
            <h1 className="text-3xl font-bold text-gray-900">π“ λ‚΄ λ…ΈνΈ</h1>
            <div className="space-x-3">
              <Link href="/create" className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                μƒ λ…ΈνΈ μƒμ„±
              </Link>
              <Link href="/" className="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                ν™μΌλ΅
              </Link>
            </div>
          </div>
          <p className="text-gray-600">
            μƒμ„±ν• λ¨λ“  ν•™μµ λ…ΈνΈλ¥Ό κ΄€λ¦¬ν•κ³  λ‹¤μ΄λ΅λ“ν•  μ μμµλ‹λ‹¤.
          </p>
        </div>

        {/* Search and Controls */}
        <div className="bg-white rounded-lg shadow-lg p-6 mb-8">
          <div className="flex flex-col sm:flex-row gap-4">
            <div className="flex-1">
              <input
                type="text"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                placeholder="λ…ΈνΈ μ λ©, μ±„λ„λ…, ν•µμ‹¬ μΈμ‚¬μ΄νΈλ΅ κ²€μƒ‰..."
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div className="flex space-x-3">
              <div className="text-sm text-gray-600 self-center">
                μ΄ {filteredNotes.length}κ° λ…ΈνΈ
              </div>
              {savedNotes.length > 0 && (
                <button
                  onClick={clearAllNotes}
                  className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors"
                >
                  μ „μ²΄ μ‚­μ 
                </button>
              )}
            </div>
          </div>
        </div>

        {/* Notes List */}
        {filteredNotes.length === 0 ? (
          <div className="bg-white rounded-lg shadow-lg p-8 text-center">
            <div className="text-6xl mb-4">π“</div>
            <h2 className="text-2xl font-bold text-gray-900 mb-4">
              {savedNotes.length === 0 ? 'μ €μ¥λ λ…ΈνΈκ°€ μ—†μµλ‹λ‹¤' : 'κ²€μƒ‰ κ²°κ³Όκ°€ μ—†μµλ‹λ‹¤'}
            </h2>
            <p className="text-gray-600 mb-6">
              {savedNotes.length === 0 
                ? 'YouTube μμƒμΌλ΅ μ²« λ²μ§Έ ν•™μµ λ…ΈνΈλ¥Ό μƒμ„±ν•΄λ³΄μ„Έμ”!'
                : 'λ‹¤λ¥Έ κ²€μƒ‰μ–΄λ΅ λ‹¤μ‹ μ‹λ„ν•΄λ³΄μ„Έμ”.'
              }
            </p>
            {savedNotes.length === 0 && (
              <Link href="/create" className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                μ²« λ…ΈνΈ μƒμ„±ν•κΈ°
              </Link>
            )}
          </div>
        ) : (
          <div className="space-y-6">
            {filteredNotes.map((note) => (
              <div key={note.id} className="bg-white rounded-lg shadow-lg p-6">
                <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                  <div className="flex-1">
                    <h3 className="text-xl font-bold text-gray-900 mb-2">
                      {note.title}
                    </h3>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-gray-600 mb-4">
                      <div>
                        <span className="font-semibold">μ±„λ„:</span> {note.channelTitle}
                      </div>
                      <div>
                        <span className="font-semibold">κΈΈμ΄:</span> {note.duration}
                      </div>
                      <div>
                        <span className="font-semibold">μƒμ„±μΌ:</span> {new Date(note.createdAt).toLocaleDateString('ko-KR')}
                      </div>
                    </div>

                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                      <div className="text-sm font-semibold text-yellow-800 mb-1">π’΅ ν•µμ‹¬ μΈμ‚¬μ΄νΈ</div>
                      <p className="text-yellow-700 text-sm">{note.keyInsight}</p>
                    </div>

                    <div className="text-sm text-gray-500">
                      κµ¬κ°„ μ: {note.sections?.length || 0}κ°
                    </div>
                  </div>

                  <div className="mt-4 lg:mt-0 lg:ml-6 flex flex-col space-y-2">
                    <a
                      href={note.youtubeUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors text-center text-sm"
                    >
                      π¬ μ›λ³Έ μμƒ
                    </a>
                    
                    <button
                      onClick={() => downloadNote(note)}
                      className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors text-sm"
                    >
                      π“¥ λ‹¤μ΄λ΅λ“
                    </button>
                    
                    <button
                      onClick={() => deleteNote(note.id)}
                      className="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors text-sm"
                    >
                      π—‘οΈ μ‚­μ 
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}

        {/* Storage Info */}
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-6 mt-8">
          <h3 className="font-bold text-blue-800 mb-2">π’Ύ μ €μ¥ μ •λ³΄</h3>
          <ul className="space-y-1 text-sm text-blue-700">
            <li>β€Ά λ¨λ“  λ…ΈνΈλ” λΈλΌμ°μ €μ λ΅μ»¬ μ¤ν† λ¦¬μ§€μ— μ €μ¥λ©λ‹λ‹¤.</li>
            <li>β€Ά λΈλΌμ°μ € λ°μ΄ν„°λ¥Ό μ‚­μ ν•λ©΄ λ…ΈνΈλ„ ν•¨κ» μ‚­μ λ©λ‹λ‹¤.</li>
            <li>β€Ά μ¤‘μ”ν• λ…ΈνΈλ” λ§ν¬λ‹¤μ΄ νμΌλ΅ λ‹¤μ΄λ΅λ“ν•μ—¬ λ°±μ—…ν•λ” κ²ƒμ„ κ¶μ¥ν•©λ‹λ‹¤.</li>
            <li>β€Ά λ‹¤λ¥Έ κΈ°κΈ°μ—μ„λ” λ…ΈνΈμ— μ ‘κ·Όν•  μ μ—†μµλ‹λ‹¤.</li>
          </ul>
        </div>
      </div>
    </div>
  );
}